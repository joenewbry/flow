<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>‚ñà‚ñÄ‚ñÄ ‚ñà   ‚ñà‚ñÄ‚ñà ‚ñà ‚ñà ‚ñà</h1>
            <div class="header-info">
                <span class="version">v1.0</span>
                <div class="status-indicator" id="connection-status">
                    <span class="status-dot">‚óè</span>
                    <span class="status-text">ONLINE</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Hamster Track Section -->
            <section class="hamster-section">
                <h2>‚ñì‚ñì‚ñì HAMSTER POWER ‚ñì‚ñì‚ñì</h2>
                <div class="track-container">
                    <div class="track-outer">
                        <div class="track-inner">
                            <div class="hamster" id="hamster">
                                <div class="hamster-sprite">üêπ</div>
                            </div>
                            <div class="start-line">START</div>
                            <div class="track-center">
                                <div class="next-screenshot">
                                    <div class="countdown" id="countdown">60</div>
                                    <div class="label">SECONDS</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Statistics Panel (moved below hamster) -->
            <section class="stats-section">
                <h2>‚ñì‚ñì‚ñì STATISTICS ‚ñì‚ñì‚ñì</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>TOTAL CAPTURES</h3>
                        <div class="stat-value" id="total-captures">{{ stats.total_captures or 0 }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>UNIQUE SCREENS</h3>
                        <div class="stat-value" id="unique-screens">{{ stats.unique_screens or 0 }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>AVG TEXT LENGTH</h3>
                        <div class="stat-value" id="avg-text-length">{{ stats.avg_text_length or 0 }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>DATE RANGE</h3>
                        <div class="stat-value small" id="date-range">
                            {% if stats.date_range %}
                                {{ stats.date_range.earliest[:10] }} to {{ stats.date_range.latest[:10] }}
                            {% else %}
                                NO DATA
                            {% endif %}
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Status Panel -->
            <section class="status-panel">
                <h2>‚ñì‚ñì‚ñì SYSTEM STATUS ‚ñì‚ñì‚ñì</h2>
                <div class="status-grid">
                    <div class="status-card" id="overall-status">
                        <div class="status-header">
                            <h3>OVERALL SYSTEM</h3>
                            <div class="status-badge" id="overall-badge">
                                <span class="badge-text">{{ status.overall_status|upper }}</span>
                            </div>
                        </div>
                        <div class="status-controls">
                            <button id="start-btn" class="btn btn-success" onclick="startSystem()">
                                ‚ñ∂ START
                            </button>
                            <button id="stop-btn" class="btn btn-danger" onclick="stopSystem()">
                                ‚ñ† STOP
                            </button>
                        </div>
                    </div>

                    <div class="status-card">
                        <div class="status-header">
                            <h3>CHROMADB SERVER</h3>
                            <div class="status-badge" id="chroma-badge">
                                <span class="badge-text">{{ "RUNNING" if status.chroma_db.running else "STOPPED" }}</span>
                            </div>
                        </div>
                        <div class="status-details">
                            <p>HEALTH: <span id="chroma-health">{{ "OK" if status.chroma_db.healthy else "ERROR" }}</span></p>
                            {% if status.chroma_db.pid %}
                            <p>PID: <span id="chroma-pid">{{ status.chroma_db.pid }}</span></p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="status-card">
                        <div class="status-header">
                            <h3>SCREEN CAPTURE</h3>
                            <div class="status-badge" id="capture-badge">
                                <span class="badge-text">{{ "RUNNING" if status.screen_capture.running else "STOPPED" }}</span>
                            </div>
                        </div>
                        <div class="status-details">
                            <p>HEALTH: <span id="capture-health">{{ "OK" if status.screen_capture.healthy else "ERROR" }}</span></p>
                            {% if status.screen_capture.pid %}
                            <p>PID: <span id="capture-pid">{{ status.screen_capture.pid }}</span></p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="status-card">
                        <div class="status-header">
                            <h3>MCP SERVER</h3>
                            <div class="status-badge" id="mcp-badge">
                                <span class="badge-text" id="mcp-status">CHECKING</span>
                            </div>
                        </div>
                        <div class="status-details">
                            <p>CLIENTS: <span id="mcp-clients">0</span></p>
                            <p>LAST REQUEST: <span id="mcp-last-request">NEVER</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- OCR Activity Timeline -->
            <section class="activity-section">
                <div class="section-header">
                    <h2>‚ñì‚ñì‚ñì ACTIVITY TIMELINE ‚ñì‚ñì‚ñì</h2>
                    <div class="time-controls">
                        <select id="time-range" onchange="updateActivityGraph()">
                            <option value="24">Last 24 Hours</option>
                            <option value="72" selected>Last 3 Days</option>
                            <option value="168">Last Week</option>
                        </select>
                        <button class="btn btn-secondary" onclick="refreshActivityGraph()">
                            ‚Üª REFRESH
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="activity-chart"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-color active"></span>
                        <span>CAPTURES WITH CONTENT</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color empty"></span>
                        <span>EMPTY CAPTURES</span>
                    </div>
                </div>
            </section>



            <!-- Search Interface -->
            <section class="search-section">
                <h2>‚ñì‚ñì‚ñì SEARCH OCR DATA ‚ñì‚ñì‚ñì</h2>
                <div class="search-container">
                    <div class="search-form">
                        <input type="text" id="search-query" placeholder="SEARCH FOR TEXT IN SCREENSHOTS..." class="search-input">
                        <div class="search-filters">
                            <input type="date" id="search-start-date" class="date-input">
                            <input type="date" id="search-end-date" class="date-input">
                            <button class="btn btn-primary" onclick="performSearch()">
                                üîç SEARCH
                            </button>
                        </div>
                    </div>
                    <div class="search-results" id="search-results" style="display: none;">
                        <div class="results-header">
                            <h3>Search Results</h3>
                            <span class="results-count" id="results-count">0 results</span>
                        </div>
                        <div class="results-list" id="results-list">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <script src="/static/js/dashboard.js"></script>
    <script>
        // Initialize dashboard with server data
        window.initialData = {
            status: {{ status | tojson }},
            stats: {{ stats | tojson }}
        };
        
        // Start the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });
    </script>
</body>
</html>
